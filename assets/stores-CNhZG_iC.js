import{r as e}from"./react-vendor-D1pS86Oe.js";import{n as t}from"./i18n-THkEc1_o.js";import{$ as n,B as r,L as i,P as a,R as o,z as s}from"./index-Cvv8WDLt.js";const c=e((e,s)=>({characters:[],matchRecords:[],isLoading:!1,error:null,loadData:()=>{e({isLoading:!0,error:null});try{let t=o(i.CHARACTERS,[]),n=o(i.MATCH_RECORDS,[]),a=t.map((e,t)=>({...e,order:e.order===void 0?t:e.order}));a.some((e,n)=>t[n].order===void 0)&&r(i.CHARACTERS,a),e({characters:a,matchRecords:n,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`character.errors.loadFailed`)})}},createCharacter:o=>{let{characters:c}=s();if(c.find(e=>e.name===o.name)){let n=t.t(`character.errors.alreadyExists`,{name:o.name});throw e({error:n}),Error(n)}let l=n(),u={uuid:a(),name:o.name,order:c.length,createdAt:l,updatedAt:l},d=[...c,u];return r(i.CHARACTERS,d),e({characters:d,error:null}),u},updateCharacter:(a,o)=>{let{characters:c}=s();if(!c.find(e=>e.uuid===a))return e({error:t.t(`character.errors.notFound`)}),!1;if(c.find(e=>e.name===o.trim()&&e.uuid!==a))return e({error:t.t(`character.errors.alreadyExists`,{name:o.trim()})}),!1;let l=n(),u=c.map(e=>e.uuid===a?{...e,name:o.trim(),updatedAt:l}:e);return r(i.CHARACTERS,u),e({characters:u,error:null}),!0},updateCharacterOrder:t=>{let{characters:a}=s(),o=n(),c=a.map(e=>{let n=t.indexOf(e.uuid);return n>=0?{...e,order:n,updatedAt:o}:e});r(i.CHARACTERS,c),e({characters:c,error:null})},deleteCharacter:a=>{let{characters:o,matchRecords:c}=s();if(!o.find(e=>e.uuid===a))return e({error:t.t(`character.errors.notFound`)}),!1;let l=o.filter(e=>e.uuid!==a),u=c.filter(e=>e.characterUuid!==a),d=n(),f=l.sort((e,t)=>e.order-t.order).map((e,t)=>({...e,order:t,updatedAt:d}));return r(i.CHARACTERS,f),r(i.MATCH_RECORDS,u),e({characters:f,matchRecords:u,error:null}),!0},createMatchRecord:t=>{let{matchRecords:o}=s(),c=n(),l={uuid:a(),characterUuid:t.characterUuid,seasonUuid:t.seasonUuid,job:t.job,map:t.map,isWin:t.isWin,recordedAt:c,createdAt:c,updatedAt:c},u=[...o,l];return r(i.MATCH_RECORDS,u),e({matchRecords:u,error:null}),l},deleteMatchRecord:n=>{let{matchRecords:a}=s();if(!a.find(e=>e.uuid===n))return e({error:t.t(`character.errors.matchRecordNotFound`)}),!1;let o=a.filter(e=>e.uuid!==n);return r(i.MATCH_RECORDS,o),e({matchRecords:o,error:null}),!0},clearMatchRecords:()=>{r(i.MATCH_RECORDS,[]),e({matchRecords:[],error:null})},getCharacterStatsForSeason:e=>{let{characters:t,matchRecords:n}=s(),r=l.getState().getHistoryByUuid(e);return t.map(t=>{let i=[...n.filter(n=>n.characterUuid===t.uuid&&n.seasonUuid===e)].sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime()),a=r?.characterStats.find(e=>e.character.uuid===t.uuid)?.usedJobs||[];return{character:t,usedJobs:a,recentMatches:i}}).sort((e,t)=>e.character.order-t.character.order)},getMatchRecordsForCharacter:(e,t)=>{let{matchRecords:n}=s();return n.filter(n=>!(n.characterUuid!==e||t&&n.seasonUuid!==t)).sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime())},clearError:()=>{e({error:null})}}));typeof window<`u`&&c.getState().loadData();const l=e((e,l)=>({histories:[],isLoading:!1,error:null,loadHistories:()=>{e({isLoading:!0,error:null});try{let t=o(i.HISTORIES,[]);e({histories:t,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`pages.histories.errors.loadFailed`)})}},createHistory:o=>{let{histories:s}=l();if(s.find(e=>e.seasonName===o.seasonName)){let n=t.t(`pages.histories.errors.alreadyExists`,{seasonName:o.seasonName});throw e({error:n}),Error(n)}let u=n(),d={uuid:a(),seasonName:o.seasonName,createdAt:u,updatedAt:u,characterStats:[]};if(s.length>0){let e=s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0],t=c.getState().getCharacterStatsForSeason(e.uuid),n=[];t.forEach(e=>{n.push(...e.recentMatches)}),n.length>0&&(r(`histories-${e.uuid}`,n),c.getState().clearMatchRecords())}let f=[...s,d];return r(i.HISTORIES,f),e({histories:f,error:null}),d},updateHistory:(a,o)=>{let{histories:s}=l(),c=s.findIndex(e=>e.uuid===a);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;if(o.seasonName&&s.find(e=>e.uuid!==a&&e.seasonName===o.seasonName))return e({error:t.t(`pages.histories.errors.alreadyExists`,{seasonName:o.seasonName})}),!1;let u={...s[c],...o,updatedAt:n()},d=[...s];return d[c]=u,r(i.HISTORIES,d),e({histories:d,error:null}),!0},deleteHistory:n=>{let{histories:a}=l();if(a.findIndex(e=>e.uuid===n)===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;try{s(`histories-${n}`)}catch(e){return console.error(t.t(`pages.histories.errors.deleteMatchRecordsFailed`,{uuid:n}),e),!1}let o=a.filter(e=>e.uuid!==n);return r(i.HISTORIES,o),e({histories:o,error:null}),!0},getHistoryByUuid:e=>{let{histories:t}=l();return t.find(t=>t.uuid===e)},getSortedHistories:()=>{let{histories:e}=l();return[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},addCharacterStats:(a,o)=>{let{histories:s}=l(),c=s.findIndex(e=>e.uuid===a);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),null;let u=s[c],d=u.characterStats.find(e=>e.character.uuid===o.uuid);if(d)return d;let f={character:o,usedJobs:[],recentMatches:[]},p={...u,characterStats:[...u.characterStats,f],updatedAt:n()},m=[...s];return m[c]=p,r(i.HISTORIES,m),e({histories:m,error:null}),f},addUsedJob:a=>{let{histories:o}=l(),s=o.findIndex(e=>e.uuid===a.seasonUuid);if(s===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;let c=o[s],u=c.characterStats.findIndex(e=>e.character.uuid===a.characterUuid);if(u===-1)return e({error:t.t(`pages.histories.errors.characterNotFound`)}),!1;let d=c.characterStats[u];if(d.usedJobs.includes(a.job))return!0;let f={...d,usedJobs:[...d.usedJobs,a.job]},p=[...c.characterStats];p[u]=f;let m={...c,characterStats:p,updatedAt:n()},h=[...o];return h[s]=m,r(i.HISTORIES,h),e({histories:h,error:null}),!0},getMatchRecordsForSeason:e=>{try{return o(`histories-${e}`,[])}catch(n){return console.error(t.t(`pages.histories.errors.loadMatchRecordsFailed`,{seasonUuid:e}),n),[]}},clearError:()=>{e({error:null})}}));typeof window<`u`&&l.getState().loadHistories();export{c as n,l as t};