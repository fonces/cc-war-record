import{D as e,L as t,it as n,st as r}from"./index-BERaIJaj.js";var i=e=>{let t,n=new Set,r=(e,r)=>{let i=typeof e==`function`?e(t):e;if(!Object.is(i,t)){let e=t;t=r??(typeof i!=`object`||!i)?i:Object.assign({},t,i),n.forEach(n=>n(t,e))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>o,subscribe:e=>(n.add(e),()=>n.delete(e))},o=t=e(r,i,a);return a},a=(e=>e?i(e):i),o=r(n(),1),s=e=>e;function c(e,t=s){let n=o.useSyncExternalStore(e.subscribe,o.useCallback(()=>t(e.getState()),[e,t]),o.useCallback(()=>t(e.getInitialState()),[e,t]));return o.useDebugValue(n),n}var l=e=>{let t=a(e),n=e=>c(t,e);return Object.assign(n,t),n},u=(e=>e?l(e):l);const d={RADAR_CHART_JOBS:`cc-war-record:radar-chart-jobs`},f=(e,t)=>{try{if(typeof window>`u`)return t;let n=window.localStorage.getItem(e);return n===null?t:JSON.parse(n)}catch(n){return console.error(`Error reading from localStorage (key: ${e}):`,n),t}},p=(e,t)=>{try{if(typeof window>`u`)return;window.localStorage.setItem(e,JSON.stringify(t))}catch(t){console.error(`Error writing to localStorage (key: ${e}):`,t)}},m=e=>{try{if(typeof window>`u`)return;window.localStorage.removeItem(e)}catch(t){console.error(`Error removing from localStorage (key: ${e}):`,t)}},h=()=>f(d.RADAR_CHART_JOBS,[t.PALADIN,t.WHITE_MAGE]),g=e=>{p(d.RADAR_CHART_JOBS,e)},_=()=>`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e===`x`?t:t&3|8).toString(16)}),v=()=>new Date().toISOString(),y=e=>{let t=new Date(e),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,`0`),i=String(t.getDate()).padStart(2,`0`),a=String(t.getHours()).padStart(2,`0`),o=String(t.getMinutes()).padStart(2,`0`);return`${n}-${r}-${i} ${a}:${o}`};var b=`cc-war-record-characters`,x=`cc-war-record-match-records`;const S=u((t,n)=>({characters:[],matchRecords:[],isLoading:!1,error:null,loadData:()=>{t({isLoading:!0,error:null});try{let e=f(b,[]),n=f(x,[]);t({characters:e,matchRecords:n,isLoading:!1})}catch(n){t({isLoading:!1,error:n instanceof Error?n.message:e.t(`character.errors.loadFailed`)})}},createCharacter:r=>{let{characters:i}=n();if(i.find(e=>e.name===r.name)){let n=e.t(`character.errors.alreadyExists`,{name:r.name});throw t({error:n}),Error(n)}let a=v(),o={uuid:_(),name:r.name,createdAt:a,updatedAt:a},s=[...i,o];return p(b,s),t({characters:s,error:null}),o},updateCharacter:(r,i)=>{let{characters:a}=n();if(!a.find(e=>e.uuid===r))return t({error:e.t(`character.errors.notFound`)}),!1;if(a.find(e=>e.name===i.trim()&&e.uuid!==r))return t({error:e.t(`character.errors.alreadyExists`,{name:i.trim()})}),!1;let o=v(),s=a.map(e=>e.uuid===r?{...e,name:i.trim(),updatedAt:o}:e);return p(b,s),t({characters:s,error:null}),!0},deleteCharacter:r=>{let{characters:i,matchRecords:a}=n();if(!i.find(e=>e.uuid===r))return t({error:e.t(`character.errors.notFound`)}),!1;let o=i.filter(e=>e.uuid!==r),s=a.filter(e=>e.characterUuid!==r);return p(b,o),p(x,s),t({characters:o,matchRecords:s,error:null}),!0},createMatchRecord:e=>{let{matchRecords:r}=n(),i=v(),a={uuid:_(),characterUuid:e.characterUuid,seasonUuid:e.seasonUuid,job:e.job,map:e.map,isWin:e.isWin,recordedAt:i,createdAt:i,updatedAt:i},o=[...r,a];return p(x,o),t({matchRecords:o,error:null}),a},deleteMatchRecord:r=>{let{matchRecords:i}=n();if(!i.find(e=>e.uuid===r))return t({error:e.t(`character.errors.matchRecordNotFound`)}),!1;let a=i.filter(e=>e.uuid!==r);return p(x,a),t({matchRecords:a,error:null}),!0},clearMatchRecords:()=>{p(x,[]),t({matchRecords:[],error:null})},getCharacterStatsForSeason:e=>{let{characters:t,matchRecords:r}=n(),i=w.getState().getHistoryByUuid(e);return t.map(t=>{let n=[...r.filter(n=>n.characterUuid===t.uuid&&n.seasonUuid===e)].sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime()),a=i?.characterStats.find(e=>e.character.uuid===t.uuid)?.usedJobs||[];return{character:t,usedJobs:a,recentMatches:n}}).sort((e,t)=>new Date(t.character.createdAt).getTime()-new Date(e.character.createdAt).getTime())},getMatchRecordsForCharacter:(e,t)=>{let{matchRecords:r}=n();return r.filter(n=>!(n.characterUuid!==e||t&&n.seasonUuid!==t)).sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime())},clearError:()=>{t({error:null})}}));typeof window<`u`&&S.getState().loadData();var C=`cc-war-record-histories`;const w=u((t,n)=>({histories:[],isLoading:!1,error:null,loadHistories:()=>{t({isLoading:!0,error:null});try{let e=f(C,[]);t({histories:e,isLoading:!1})}catch(n){t({isLoading:!1,error:n instanceof Error?n.message:e.t(`pages.histories.errors.loadFailed`)})}},createHistory:r=>{let{histories:i}=n();if(i.find(e=>e.seasonName===r.seasonName)){let n=e.t(`pages.histories.errors.alreadyExists`,{seasonName:r.seasonName});throw t({error:n}),Error(n)}let a=v(),o={uuid:_(),seasonName:r.seasonName,createdAt:a,updatedAt:a,characterStats:[]};if(i.length>0){let e=i.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0],t=S.getState().getCharacterStatsForSeason(e.uuid),n=[];t.forEach(e=>{n.push(...e.recentMatches)}),n.length>0&&(p(`histories-${e.uuid}`,n),S.getState().clearMatchRecords())}let s=[...i,o];return p(C,s),t({histories:s,error:null}),o},updateHistory:(r,i)=>{let{histories:a}=n(),o=a.findIndex(e=>e.uuid===r);if(o===-1)return t({error:e.t(`pages.histories.errors.notFound`)}),!1;if(i.seasonName&&a.find(e=>e.uuid!==r&&e.seasonName===i.seasonName))return t({error:e.t(`pages.histories.errors.alreadyExists`,{seasonName:i.seasonName})}),!1;let s={...a[o],...i,updatedAt:v()},c=[...a];return c[o]=s,p(C,c),t({histories:c,error:null}),!0},deleteHistory:r=>{let{histories:i}=n();if(i.findIndex(e=>e.uuid===r)===-1)return t({error:e.t(`pages.histories.errors.notFound`)}),!1;try{m(`histories-${r}`)}catch(t){return console.error(e.t(`pages.histories.errors.deleteMatchRecordsFailed`,{uuid:r}),t),!1}let a=i.filter(e=>e.uuid!==r);return p(C,a),t({histories:a,error:null}),!0},getHistoryByUuid:e=>{let{histories:t}=n();return t.find(t=>t.uuid===e)},getSortedHistories:()=>{let{histories:e}=n();return[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},addCharacterStats:(r,i)=>{let{histories:a}=n(),o=a.findIndex(e=>e.uuid===r);if(o===-1)return t({error:e.t(`pages.histories.errors.notFound`)}),null;let s=a[o],c=s.characterStats.find(e=>e.character.uuid===i.uuid);if(c)return c;let l={character:i,usedJobs:[],recentMatches:[]},u={...s,characterStats:[...s.characterStats,l],updatedAt:v()},d=[...a];return d[o]=u,p(C,d),t({histories:d,error:null}),l},addUsedJob:r=>{let{histories:i}=n(),a=i.findIndex(e=>e.uuid===r.seasonUuid);if(a===-1)return t({error:e.t(`pages.histories.errors.notFound`)}),!1;let o=i[a],s=o.characterStats.findIndex(e=>e.character.uuid===r.characterUuid);if(s===-1)return t({error:e.t(`pages.histories.errors.characterNotFound`)}),!1;let c=o.characterStats[s];if(c.usedJobs.includes(r.job))return!0;let l={...c,usedJobs:[...c.usedJobs,r.job]},u=[...o.characterStats];u[s]=l;let d={...o,characterStats:u,updatedAt:v()},f=[...i];return f[a]=d,p(C,f),t({histories:f,error:null}),!0},getMatchRecordsForSeason:t=>{try{return f(`histories-${t}`,[])}catch(n){return console.error(e.t(`pages.histories.errors.loadMatchRecordsFailed`,{seasonUuid:t}),n),[]}},clearError:()=>{t({error:null})}}));typeof window<`u`&&w.getState().loadHistories();export{g as a,h as i,S as n,y as r,w as t};