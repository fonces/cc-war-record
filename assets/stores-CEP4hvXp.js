import{r as e}from"./react-vendor-D1pS86Oe.js";import{n as t}from"./i18n-THkEc1_o.js";import{H as n,L as r,U as i,V as a,W as o,it as s}from"./index-BFuuQ0uR.js";const c=e((e,i)=>({characters:[],matchRecords:[],isLoading:!1,error:null,loadData:()=>{e({isLoading:!0,error:null});try{let t=n(a.CHARACTERS,[]),r=n(a.MATCH_RECORDS,[]),i=t.map((e,t)=>({...e,order:e.order===void 0?t:e.order}));i.some((e,n)=>t[n].order===void 0)&&o(a.CHARACTERS,i),e({characters:i,matchRecords:r,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`character.errors.loadFailed`)})}},createCharacter:n=>{let{characters:c}=i();if(c.find(e=>e.name===n.name)){let r=t.t(`character.errors.alreadyExists`,{name:n.name});throw e({error:r}),Error(r)}let l=s(),u={uuid:r(),name:n.name,order:c.length,createdAt:l,updatedAt:l},d=[...c,u];return o(a.CHARACTERS,d),e({characters:d,error:null}),u},updateCharacter:(n,r)=>{let{characters:c}=i();if(!c.find(e=>e.uuid===n))return e({error:t.t(`character.errors.notFound`)}),!1;if(c.find(e=>e.name===r.trim()&&e.uuid!==n))return e({error:t.t(`character.errors.alreadyExists`,{name:r.trim()})}),!1;let l=s(),u=c.map(e=>e.uuid===n?{...e,name:r.trim(),updatedAt:l}:e);return o(a.CHARACTERS,u),e({characters:u,error:null}),!0},updateCharacterOrder:t=>{let{characters:n}=i(),r=s(),c=n.map(e=>{let n=t.indexOf(e.uuid);return n>=0?{...e,order:n,updatedAt:r}:e});o(a.CHARACTERS,c),e({characters:c,error:null})},deleteCharacter:n=>{let{characters:r,matchRecords:c}=i();if(!r.find(e=>e.uuid===n))return e({error:t.t(`character.errors.notFound`)}),!1;let l=r.filter(e=>e.uuid!==n),u=c.filter(e=>e.characterUuid!==n),d=s(),f=l.sort((e,t)=>e.order-t.order).map((e,t)=>({...e,order:t,updatedAt:d}));return o(a.CHARACTERS,f),o(a.MATCH_RECORDS,u),e({characters:f,matchRecords:u,error:null}),!0},createMatchRecord:t=>{let{matchRecords:n}=i(),c=s(),l={uuid:r(),characterUuid:t.characterUuid,seasonUuid:t.seasonUuid,job:t.job,map:t.map,isWin:t.isWin,recordedAt:c,createdAt:c,updatedAt:c},u=[...n,l];return o(a.MATCH_RECORDS,u),e({matchRecords:u,error:null}),l},deleteMatchRecord:n=>{let{matchRecords:r}=i();if(!r.find(e=>e.uuid===n))return e({error:t.t(`character.errors.matchRecordNotFound`)}),!1;let s=r.filter(e=>e.uuid!==n);return o(a.MATCH_RECORDS,s),e({matchRecords:s,error:null}),!0},clearMatchRecords:()=>{o(a.MATCH_RECORDS,[]),e({matchRecords:[],error:null})},getCharacterStatsForSeason:e=>{let{characters:t,matchRecords:n}=i(),r=l.getState().getHistoryByUuid(e);return t.map(t=>{let i=[...n.filter(n=>n.characterUuid===t.uuid&&n.seasonUuid===e)].sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime()),a=r?.characterStats.find(e=>e.character.uuid===t.uuid)?.usedJobs||[];return{character:t,usedJobs:a,recentMatches:i}}).sort((e,t)=>e.character.order-t.character.order)},getMatchRecordsForCharacter:(e,t)=>{let{matchRecords:n}=i();return n.filter(n=>!(n.characterUuid!==e||t&&n.seasonUuid!==t)).sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime())},clearError:()=>{e({error:null})}}));typeof window<`u`&&c.getState().loadData();const l=e((e,l)=>({histories:[],isLoading:!1,error:null,loadHistories:()=>{e({isLoading:!0,error:null});try{let t=n(a.HISTORIES,[]);e({histories:t,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`pages.histories.errors.loadFailed`)})}},createHistory:n=>{let{histories:i}=l();if(i.find(e=>e.seasonName===n.seasonName)){let r=t.t(`pages.histories.errors.alreadyExists`,{seasonName:n.seasonName});throw e({error:r}),Error(r)}let u=s(),d={uuid:r(),seasonName:n.seasonName,createdAt:u,updatedAt:u,characterStats:[]};if(i.length>0){let e=i.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0],t=c.getState().getCharacterStatsForSeason(e.uuid),n=[];t.forEach(e=>{n.push(...e.recentMatches)}),n.length>0&&(o(`histories-${e.uuid}`,n),c.getState().clearMatchRecords())}let f=[...i,d];return o(a.HISTORIES,f),e({histories:f,error:null}),d},updateHistory:(n,r)=>{let{histories:i}=l(),c=i.findIndex(e=>e.uuid===n);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;if(r.seasonName&&i.find(e=>e.uuid!==n&&e.seasonName===r.seasonName))return e({error:t.t(`pages.histories.errors.alreadyExists`,{seasonName:r.seasonName})}),!1;let u={...i[c],...r,updatedAt:s()},d=[...i];return d[c]=u,o(a.HISTORIES,d),e({histories:d,error:null}),!0},deleteHistory:n=>{let{histories:r}=l();if(r.findIndex(e=>e.uuid===n)===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;try{i(`histories-${n}`)}catch(e){return console.error(t.t(`pages.histories.errors.deleteMatchRecordsFailed`,{uuid:n}),e),!1}let s=r.filter(e=>e.uuid!==n);return o(a.HISTORIES,s),e({histories:s,error:null}),!0},getHistoryByUuid:e=>{let{histories:t}=l();return t.find(t=>t.uuid===e)},getSortedHistories:()=>{let{histories:e}=l();return[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},addCharacterStats:(n,r)=>{let{histories:i}=l(),c=i.findIndex(e=>e.uuid===n);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),null;let u=i[c],d=u.characterStats.find(e=>e.character.uuid===r.uuid);if(d)return d;let f={character:r,usedJobs:[],recentMatches:[]},p={...u,characterStats:[...u.characterStats,f],updatedAt:s()},m=[...i];return m[c]=p,o(a.HISTORIES,m),e({histories:m,error:null}),f},addUsedJob:n=>{let{histories:r}=l(),i=r.findIndex(e=>e.uuid===n.seasonUuid);if(i===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;let c=r[i],u=c.characterStats.findIndex(e=>e.character.uuid===n.characterUuid);if(u===-1)return e({error:t.t(`pages.histories.errors.characterNotFound`)}),!1;let d=c.characterStats[u];if(d.usedJobs.includes(n.job))return!0;let f={...d,usedJobs:[...d.usedJobs,n.job]},p=[...c.characterStats];p[u]=f;let m={...c,characterStats:p,updatedAt:s()},h=[...r];return h[i]=m,o(a.HISTORIES,h),e({histories:h,error:null}),!0},getMatchRecordsForSeason:e=>{try{return n(`histories-${e}`,[])}catch(n){return console.error(t.t(`pages.histories.errors.loadMatchRecordsFailed`,{seasonUuid:e}),n),[]}},clearError:()=>{e({error:null})}}));typeof window<`u`&&l.getState().loadHistories();export{c as n,l as t};