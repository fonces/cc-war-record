import{r as e}from"./react-vendor-D1pS86Oe.js";import{n as t}from"./i18n-THkEc1_o.js";import{B as n,H as r,L as i,U as a,V as o,nt as s}from"./index-BXtaWAWr.js";const c=e((e,r)=>({characters:[],matchRecords:[],isLoading:!1,error:null,loadData:()=>{e({isLoading:!0,error:null});try{let t=o(n.CHARACTERS,[]),r=o(n.MATCH_RECORDS,[]),i=t.map((e,t)=>({...e,order:e.order===void 0?t:e.order}));i.some((e,n)=>t[n].order===void 0)&&a(n.CHARACTERS,i),e({characters:i,matchRecords:r,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`character.errors.loadFailed`)})}},createCharacter:o=>{let{characters:c}=r();if(c.find(e=>e.name===o.name)){let n=t.t(`character.errors.alreadyExists`,{name:o.name});throw e({error:n}),Error(n)}let l=s(),u={uuid:i(),name:o.name,order:c.length,createdAt:l,updatedAt:l},d=[...c,u];return a(n.CHARACTERS,d),e({characters:d,error:null}),u},updateCharacter:(i,o)=>{let{characters:c}=r();if(!c.find(e=>e.uuid===i))return e({error:t.t(`character.errors.notFound`)}),!1;if(c.find(e=>e.name===o.trim()&&e.uuid!==i))return e({error:t.t(`character.errors.alreadyExists`,{name:o.trim()})}),!1;let l=s(),u=c.map(e=>e.uuid===i?{...e,name:o.trim(),updatedAt:l}:e);return a(n.CHARACTERS,u),e({characters:u,error:null}),!0},updateCharacterOrder:t=>{let{characters:i}=r(),o=s(),c=i.map(e=>{let n=t.indexOf(e.uuid);return n>=0?{...e,order:n,updatedAt:o}:e});a(n.CHARACTERS,c),e({characters:c,error:null})},deleteCharacter:i=>{let{characters:o,matchRecords:c}=r();if(!o.find(e=>e.uuid===i))return e({error:t.t(`character.errors.notFound`)}),!1;let l=o.filter(e=>e.uuid!==i),u=c.filter(e=>e.characterUuid!==i),d=s(),f=l.sort((e,t)=>e.order-t.order).map((e,t)=>({...e,order:t,updatedAt:d}));return a(n.CHARACTERS,f),a(n.MATCH_RECORDS,u),e({characters:f,matchRecords:u,error:null}),!0},createMatchRecord:t=>{let{matchRecords:o}=r(),c=s(),l={uuid:i(),characterUuid:t.characterUuid,seasonUuid:t.seasonUuid,job:t.job,map:t.map,isWin:t.isWin,recordedAt:c,createdAt:c,updatedAt:c},u=[...o,l];return a(n.MATCH_RECORDS,u),e({matchRecords:u,error:null}),l},deleteMatchRecord:i=>{let{matchRecords:o}=r();if(!o.find(e=>e.uuid===i))return e({error:t.t(`character.errors.matchRecordNotFound`)}),!1;let s=o.filter(e=>e.uuid!==i);return a(n.MATCH_RECORDS,s),e({matchRecords:s,error:null}),!0},clearMatchRecords:()=>{a(n.MATCH_RECORDS,[]),e({matchRecords:[],error:null})},getCharacterStatsForSeason:e=>{let{characters:t,matchRecords:n}=r(),i=l.getState().getHistoryByUuid(e);return t.map(t=>{let r=[...n.filter(n=>n.characterUuid===t.uuid&&n.seasonUuid===e)].sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime()),a=i?.characterStats.find(e=>e.character.uuid===t.uuid)?.usedJobs||[];return{character:t,usedJobs:a,recentMatches:r}}).sort((e,t)=>e.character.order-t.character.order)},getMatchRecordsForCharacter:(e,t)=>{let{matchRecords:n}=r();return n.filter(n=>!(n.characterUuid!==e||t&&n.seasonUuid!==t)).sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime())},clearError:()=>{e({error:null})}}));typeof window<`u`&&c.getState().loadData();const l=e((e,l)=>({histories:[],isLoading:!1,error:null,loadHistories:()=>{e({isLoading:!0,error:null});try{let t=o(n.HISTORIES,[]);e({histories:t,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`pages.histories.errors.loadFailed`)})}},createHistory:r=>{let{histories:o}=l();if(o.find(e=>e.seasonName===r.seasonName)){let n=t.t(`pages.histories.errors.alreadyExists`,{seasonName:r.seasonName});throw e({error:n}),Error(n)}let u=s(),d={uuid:i(),seasonName:r.seasonName,createdAt:u,updatedAt:u,characterStats:[]};if(o.length>0){let e=o.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0],t=c.getState().getCharacterStatsForSeason(e.uuid),n=[];t.forEach(e=>{n.push(...e.recentMatches)}),n.length>0&&(a(`histories-${e.uuid}`,n),c.getState().clearMatchRecords())}let f=[...o,d];return a(n.HISTORIES,f),e({histories:f,error:null}),d},updateHistory:(r,i)=>{let{histories:o}=l(),c=o.findIndex(e=>e.uuid===r);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;if(i.seasonName&&o.find(e=>e.uuid!==r&&e.seasonName===i.seasonName))return e({error:t.t(`pages.histories.errors.alreadyExists`,{seasonName:i.seasonName})}),!1;let u={...o[c],...i,updatedAt:s()},d=[...o];return d[c]=u,a(n.HISTORIES,d),e({histories:d,error:null}),!0},deleteHistory:i=>{let{histories:o}=l();if(o.findIndex(e=>e.uuid===i)===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;try{r(`histories-${i}`)}catch(e){return console.error(t.t(`pages.histories.errors.deleteMatchRecordsFailed`,{uuid:i}),e),!1}let s=o.filter(e=>e.uuid!==i);return a(n.HISTORIES,s),e({histories:s,error:null}),!0},getHistoryByUuid:e=>{let{histories:t}=l();return t.find(t=>t.uuid===e)},getSortedHistories:()=>{let{histories:e}=l();return[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},addCharacterStats:(r,i)=>{let{histories:o}=l(),c=o.findIndex(e=>e.uuid===r);if(c===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),null;let u=o[c],d=u.characterStats.find(e=>e.character.uuid===i.uuid);if(d)return d;let f={character:i,usedJobs:[],recentMatches:[]},p={...u,characterStats:[...u.characterStats,f],updatedAt:s()},m=[...o];return m[c]=p,a(n.HISTORIES,m),e({histories:m,error:null}),f},addUsedJob:r=>{let{histories:i}=l(),o=i.findIndex(e=>e.uuid===r.seasonUuid);if(o===-1)return e({error:t.t(`pages.histories.errors.notFound`)}),!1;let c=i[o],u=c.characterStats.findIndex(e=>e.character.uuid===r.characterUuid);if(u===-1)return e({error:t.t(`pages.histories.errors.characterNotFound`)}),!1;let d=c.characterStats[u];if(d.usedJobs.includes(r.job))return!0;let f={...d,usedJobs:[...d.usedJobs,r.job]},p=[...c.characterStats];p[u]=f;let m={...c,characterStats:p,updatedAt:s()},h=[...i];return h[o]=m,a(n.HISTORIES,h),e({histories:h,error:null}),!0},getMatchRecordsForSeason:e=>{try{return o(`histories-${e}`,[])}catch(n){return console.error(t.t(`pages.histories.errors.loadMatchRecordsFailed`,{seasonUuid:e}),n),[]}},clearError:()=>{e({error:null})}}));typeof window<`u`&&l.getState().loadHistories();export{c as n,l as t};