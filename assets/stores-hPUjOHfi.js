import{I as e,d as t,y as n,z as r}from"./index-DhA9AGh8.js";var i=e=>{let t,n=new Set,r=(e,r)=>{let i=typeof e==`function`?e(t):e;if(!Object.is(i,t)){let e=t;t=r??(typeof i!=`object`||!i)?i:Object.assign({},t,i),n.forEach(n=>n(t,e))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>o,subscribe:e=>(n.add(e),()=>n.delete(e))},o=t=e(r,i,a);return a},a=(e=>e?i(e):i),o=r(e(),1),s=e=>e;function c(e,t=s){let n=o.useSyncExternalStore(e.subscribe,o.useCallback(()=>t(e.getState()),[e,t]),o.useCallback(()=>t(e.getInitialState()),[e,t]));return o.useDebugValue(n),n}var l=e=>{let t=a(e),n=e=>c(t,e);return Object.assign(n,t),n},u=(e=>e?l(e):l);const d=()=>`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e===`x`?t:t&3|8).toString(16)}),f=()=>new Date().toISOString(),p=e=>{let t=new Date(e),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,`0`),i=String(t.getDate()).padStart(2,`0`),a=String(t.getHours()).padStart(2,`0`),o=String(t.getMinutes()).padStart(2,`0`);return`${n}-${r}-${i} ${a}:${o}`},m={RADAR_CHART_JOBS:`cc-war-record:radar-chart-jobs`},h=(e,t)=>{try{if(typeof window>`u`)return t;let n=window.localStorage.getItem(e);return n===null?t:JSON.parse(n)}catch(n){return console.error(`Error reading from localStorage (key: ${e}):`,n),t}},g=(e,t)=>{try{if(typeof window>`u`)return;window.localStorage.setItem(e,JSON.stringify(t))}catch(t){console.error(`Error writing to localStorage (key: ${e}):`,t)}},_=e=>{try{if(typeof window>`u`)return;window.localStorage.removeItem(e)}catch(t){console.error(`Error removing from localStorage (key: ${e}):`,t)}},v=()=>h(m.RADAR_CHART_JOBS,[n.PALADIN,n.WHITE_MAGE]),y=e=>{g(m.RADAR_CHART_JOBS,e)};var b=`cc-war-record-characters`,x=`cc-war-record-match-records`;const S=u((e,n)=>({characters:[],matchRecords:[],isLoading:!1,error:null,loadData:()=>{e({isLoading:!0,error:null});try{let t=h(b,[]),n=h(x,[]);e({characters:t,matchRecords:n,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`character.errors.loadFailed`)})}},createCharacter:r=>{let{characters:i}=n();if(i.find(e=>e.name===r.name)){let n=t.t(`character.errors.alreadyExists`,{name:r.name});throw e({error:n}),Error(n)}let a=f(),o={uuid:d(),name:r.name,createdAt:a,updatedAt:a},s=[...i,o];return g(b,s),e({characters:s,error:null}),o},updateCharacter:(r,i)=>{let{characters:a}=n();if(!a.find(e=>e.uuid===r))return e({error:t.t(`character.errors.notFound`)}),!1;if(a.find(e=>e.name===i.trim()&&e.uuid!==r))return e({error:t.t(`character.errors.alreadyExists`,{name:i.trim()})}),!1;let o=f(),s=a.map(e=>e.uuid===r?{...e,name:i.trim(),updatedAt:o}:e);return g(b,s),e({characters:s,error:null}),!0},deleteCharacter:r=>{let{characters:i,matchRecords:a}=n();if(!i.find(e=>e.uuid===r))return e({error:t.t(`character.errors.notFound`)}),!1;let o=i.filter(e=>e.uuid!==r),s=a.filter(e=>e.characterUuid!==r);return g(b,o),g(x,s),e({characters:o,matchRecords:s,error:null}),!0},createMatchRecord:t=>{let{matchRecords:r}=n(),i=f(),a={uuid:d(),characterUuid:t.characterUuid,seasonUuid:t.seasonUuid,job:t.job,map:t.map,isWin:t.isWin,recordedAt:i,createdAt:i,updatedAt:i},o=[...r,a];return g(x,o),e({matchRecords:o,error:null}),a},deleteMatchRecord:r=>{let{matchRecords:i}=n();if(!i.find(e=>e.uuid===r))return e({error:t.t(`character.errors.matchRecordNotFound`)}),!1;let a=i.filter(e=>e.uuid!==r);return g(x,a),e({matchRecords:a,error:null}),!0},clearMatchRecords:()=>{g(x,[]),e({matchRecords:[],error:null})},getCharacterStatsForSeason:e=>{let{characters:t,matchRecords:r}=n(),i=w.getState().getHistoryByUuid(e);return t.map(t=>{let n=[...r.filter(n=>n.characterUuid===t.uuid&&n.seasonUuid===e)].sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime()),a=i?.characterStats.find(e=>e.character.uuid===t.uuid)?.usedJobs||[];return{character:t,usedJobs:a,recentMatches:n}}).sort((e,t)=>new Date(t.character.createdAt).getTime()-new Date(e.character.createdAt).getTime())},getMatchRecordsForCharacter:(e,t)=>{let{matchRecords:r}=n();return r.filter(n=>!(n.characterUuid!==e||t&&n.seasonUuid!==t)).sort((e,t)=>new Date(t.recordedAt).getTime()-new Date(e.recordedAt).getTime())},clearError:()=>{e({error:null})}}));typeof window<`u`&&S.getState().loadData();var C=`cc-war-record-histories`;const w=u((e,n)=>({histories:[],isLoading:!1,error:null,loadHistories:()=>{e({isLoading:!0,error:null});try{let t=h(C,[]);e({histories:t,isLoading:!1})}catch(n){e({isLoading:!1,error:n instanceof Error?n.message:t.t(`histories.errors.loadFailed`)})}},createHistory:r=>{let{histories:i}=n();if(i.find(e=>e.seasonName===r.seasonName)){let n=t.t(`histories.errors.alreadyExists`,{seasonName:r.seasonName});throw e({error:n}),Error(n)}let a=f(),o={uuid:d(),seasonName:r.seasonName,createdAt:a,updatedAt:a,characterStats:[]};if(i.length>0){let e=i.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0],t=S.getState().getCharacterStatsForSeason(e.uuid),n=[];t.forEach(e=>{n.push(...e.recentMatches)}),n.length>0&&(g(`histories-${e.uuid}`,n),S.getState().clearMatchRecords())}let s=[...i,o];return g(C,s),e({histories:s,error:null}),o},updateHistory:(r,i)=>{let{histories:a}=n(),o=a.findIndex(e=>e.uuid===r);if(o===-1)return e({error:t.t(`histories.errors.notFound`)}),!1;if(i.seasonName&&a.find(e=>e.uuid!==r&&e.seasonName===i.seasonName))return e({error:t.t(`histories.errors.alreadyExists`,{seasonName:i.seasonName})}),!1;let s={...a[o],...i,updatedAt:f()},c=[...a];return c[o]=s,g(C,c),e({histories:c,error:null}),!0},deleteHistory:r=>{let{histories:i}=n();if(i.findIndex(e=>e.uuid===r)===-1)return e({error:t.t(`histories.errors.notFound`)}),!1;try{_(`histories-${r}`)}catch(e){return console.error(`Error deleting match records for season ${r}:`,e),!1}let a=i.filter(e=>e.uuid!==r);return g(C,a),e({histories:a,error:null}),!0},getHistoryByUuid:e=>{let{histories:t}=n();return t.find(t=>t.uuid===e)},getSortedHistories:()=>{let{histories:e}=n();return[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},addCharacterStats:(r,i)=>{let{histories:a}=n(),o=a.findIndex(e=>e.uuid===r);if(o===-1)return e({error:t.t(`histories.errors.notFound`)}),null;let s=a[o],c=s.characterStats.find(e=>e.character.uuid===i.uuid);if(c)return c;let l={character:i,usedJobs:[],recentMatches:[]},u={...s,characterStats:[...s.characterStats,l],updatedAt:f()},d=[...a];return d[o]=u,g(C,d),e({histories:d,error:null}),l},addUsedJob:r=>{let{histories:i}=n(),a=i.findIndex(e=>e.uuid===r.seasonUuid);if(a===-1)return e({error:t.t(`histories.errors.notFound`)}),!1;let o=i[a],s=o.characterStats.findIndex(e=>e.character.uuid===r.characterUuid);if(s===-1)return e({error:t.t(`histories.errors.characterNotFound`)}),!1;let c=o.characterStats[s];if(c.usedJobs.includes(r.job))return!0;let l={...c,usedJobs:[...c.usedJobs,r.job]},u=[...o.characterStats];u[s]=l;let d={...o,characterStats:u,updatedAt:f()},p=[...i];return p[a]=d,g(C,p),e({histories:p,error:null}),!0},getMatchRecordsForSeason:e=>{try{return h(`histories-${e}`,[])}catch(t){return console.error(`Error loading match records for season ${e}:`,t),[]}},clearError:()=>{e({error:null})}}));typeof window<`u`&&w.getState().loadHistories();export{p as a,y as i,S as n,v as r,w as t};